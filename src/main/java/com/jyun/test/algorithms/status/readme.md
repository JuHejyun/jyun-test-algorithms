  最近在对公司以前的一个项目进行调整时发现，数据库中有很多表示“多选状态标识”的字段。“多选状态标识”可能描述的并不十分准确，在这里用我们项目中的几个例子进行说明一下。
      例一：表示某个商家是否支持多种会员卡打折（如有金卡、银卡、其他卡等），项目中的以往的做法是：在每条商家记录中为每种会员卡建立一个标志位字段。如图：


 
      其中蓝色区域的三个整形字段分别表示三种会员卡。当值为“1”时表示当前商家支持这种会员卡打折，反之“0”则表示不支持。
 
      例二：表示系统字典表中某种类型方式，会在哪个功能模块中调用。如某种“支付方式”可能在“收银模块”中会用到，在“结算模块”中也会用到。如图：



 

      用多字段来表示“多选标识”存在一定的缺点：首先这种设置方式很明显不符合数据库设计第一范式，增加了数据冗余和存储空间。再者，当业务发生变化时，不利于灵活调整。比如，增加了一种新的会员卡类型时，需要在数据表中增加一个新的字段，以适应需求的变化。
 
      因此，我们在重新审视数据库设计时，我的一位同事提出了一种代替方式：将多个状态标识字段合并成一个字段，并把这个字段改成字符串型，对多选状态值以字符串数组的方式保存（一个以逗号分隔的字符串：“1,2,3”）。表的结构变成如下：


 

     “MEMBERCARD”字段中，当存在“1”时表示支持金卡打折，“2”时表示支持银卡打折，“3”表示支持其他卡打折。
      这样调整的好处，不仅消除相同字段的冗余，而且当增加新的会员卡类别时，不需增加新的字段。但带来新的问题：在数据查询时，需要对字符串进行分隔。并且字符串类型的字段在查询效率和存储空间上不如整型字段。
 
      总的来说，上面调整的思路是正确的，但不够自然。我后来考虑了一下，觉得可以用“位”来解决这个问题：二进制的“位”本来就有表示状态的作用。可以用下面各个位来分别表示不同种类的会员卡打折支持：


 
      这样，“MEMBERCARD”字段仍采用整型。当某个商家支持金卡打折时，则保存“1（0001）”，支持银卡时，则保存“2（0010）”，两种都支持，则保存“3（0011）”。其他类似。表结构如图：


 

我们在编写SQL语句时，只需要通过“位”的与运算，就能简单的查询出想要数据：

[java] view plaincopy

//查询支持金卡打折的商家信息：  
select * from factory where MEMBERCARD & b'0001'  
或者：  
select * from factory where MEMBERCARD & 1  
  
//查询支持银卡打折的商家信息：  
select * from factory where MEMBERCARD & b'0010'  
或者：  
Select * from factory where MEMBERCARD & 2  
 

      通过这样的处理方式既节省存储空间，查询时又简单方便。以上sql语句为MySql的语法，其他数据库方法类似。并且“b'0010'”二进制的表示方式的语法是在5.0以后的版本才有。



      注意：这种情况不同于在多种状态中只可能处于一种状态的情况，如性别等。
      
      
      
      需求: 任务系统中有多个任务, 用户完成每个任务都可以领取奖励, 为防止同一个任务奖励被同一个用户多次领取,需要将领取过的标记一下
      
      比较直接的数据库表设计看起来像这样: 用户ID,任务ID,是否领取 
      不过这里要说的是另外一种设计: 用户ID,领取状态(一个整型字段) 
      限制: 领取状态字段为32位整型时只能存储任务ID在[1-32)范围内的31个状态值, 64位时为[1-64)内的63个值 
      PHP代码示例:
      
      error_reporting(E_ALL ^ E_NOTICE);
      
      $status = 0; //多个任务的领取状态
      
      $tid1 = 9; //任务ID
      $mask1 = $tid1 > 2 ? (2 << ($tid1 - 2)) : $tid1;
      $status |= $mask1; //标识指定任务的领取状态为已领取
      
      $tid2 = 1;
      $mask2 = $tid2 > 2 ? (2 << ($tid2 - 2)) : $tid2;
      $status |= $mask2;
      
      $tid3 = 12;
      echo "任务 {$tid1}: ", ($mask1 & $status ? '已' : '未'), "领取\n";
      echo "任务 {$tid2}: ", ($mask2 & $status ? '已' : '未'), "领取\n";
      echo "任务 {$tid3}: ", ($mask3 & $status ? '已' : '未'), "领取\n";
      
      //MySQL更新 UPDATE uinfo SET status = status | $mask WHERE uid=$uid